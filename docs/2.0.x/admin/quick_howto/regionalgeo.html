

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Configure Regional Geo-blocking (RGB) &mdash; Traffic Control 1.8-dev documentation </title>
  

  
  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../../_static/theme_overrides.css" type="text/css" />
  

  
        <link rel="index" title="Index"
              href="../../genindex.html"/>
        <link rel="search" title="Search" href="../../search.html"/>
    <link rel="top" title="Traffic Control 1.8-dev documentation" href="../../index.html"/>
        <link rel="up" title="Quick How To Guides" href="index.html"/>
        <link rel="next" title="Configure Delivery Service Steering" href="steering.html"/>
        <link rel="prev" title="Configure Federations" href="federations.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        

        
          <a href="/" class="icon icon-home"> Traffic Control
        

        
          
          <img src="../../_static/tc_logo_c_only.png" class="logo" />
        
        </a>

        
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

        
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
          
          
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../basics/index.html">CDN Basics</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../basics/content_delivery_networks.html">Content Delivery Networks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../basics/http_11.html">HTTP 1.1</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../basics/caching_proxies.html">Caching Proxies</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../basics/cache_revalidation.html">Cache Control Headers and Revalidation</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../overview/index.html">Traffic Control Overview</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../overview/introduction.html">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../overview/traffic_ops.html">Traffic Ops</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../overview/traffic_portal.html">Traffic Portal</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../overview/traffic_router.html">Traffic Router</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../overview/traffic_monitor.html">Traffic Monitor</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../overview/traffic_stats.html">Traffic Stats</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../overview/traffic_server.html">Traffic Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../overview/traffic_vault.html">Traffic Vault</a></li>
</ul>
</li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Administrator&#8217;s Guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../traffic_ops_install.html">Installing Traffic Ops</a></li>
<li class="toctree-l2"><a class="reference internal" href="../traffic_ops_config.html">Configuring Traffic Ops</a></li>
<li class="toctree-l2"><a class="reference internal" href="../traffic_ops_using.html">Using Traffic Ops</a></li>
<li class="toctree-l2"><a class="reference internal" href="../traffic_ops_extensions.html">Managing Traffic Ops Extensions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../traffic_portal.html">Traffic Portal Administration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../traffic_monitor.html">Traffic Monitor Administration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../traffic_router.html">Traffic Router Administration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../traffic_stats.html">Traffic Stats Administration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../traffic_server.html">Traffic Server Administration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../traffic_vault.html">Traffic Vault Administration</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Quick How To Guides</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../development/index.html">Developer&#8217;s Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../development/traffic_ops.html">Traffic Ops</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../development/traffic_portal.html">Traffic Portal</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../development/traffic_router.html">Traffic Router</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../development/traffic_monitor.html">Traffic Monitor</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../development/traffic_stats.html">Traffic Stats</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../development/traffic_server.html">Traffic Server</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../faq/index.html">FAQ</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../faq/general.html">General</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../faq/development.html">Development</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../faq/administration.html">Running a Traffic Control CDN</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../glossary.html">Glossary</a></li>
</ul>

          
        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">Traffic Control</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Traffic Control 1.8-dev</a> &raquo;</li>
      
          <li><a href="../index.html">Administrator&#8217;s Guide</a> &raquo;</li>
      
          <li><a href="index.html">Quick How To Guides</a> &raquo;</li>
      
    <li>Configure Regional Geo-blocking (RGB)</li>
      <li class="wy-breadcrumbs-aside">
        
          <a href="../../_sources/admin/quick_howto/regionalgeo.rst.txt" rel="nofollow"> View page source</a>
        
      </li>
  </ul>
  <hr/>
</div>
 		  
    		  <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      		  
        		  <a href="steering.html" class="btn btn-neutral float-right" title="Configure Delivery Service Steering">Next <span class="fa fa-arrow-circle-right"></span></a>
      		  
      		  
        		  <a href="federations.html" class="btn btn-neutral" title="Configure Federations"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      		  
    		  </div>
  		  
          <div role="main" class="document">
            
  <div class="section" id="configure-regional-geo-blocking-rgb">
<span id="rl-regionalgeo-qht"></span><h1>Configure Regional Geo-blocking (RGB)<a class="headerlink" href="#configure-regional-geo-blocking-rgb" title="Permalink to this headline">¶</a></h1>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">RGB is only supported for HTTP delivery services.</p>
</div>
<ol class="arabic simple">
<li>Prepare RGB configuration file</li>
</ol>
<p>RGB uses a configuration file in JSON format to define regional geo-blocking rules for delivery services. The file needs to be put on an HTTP server accessible to Traffic Router. An example of the JSON is as follows:</p>
<div class="highlight-default"><div class="highlight"><pre><span class="p">{</span>
<span class="s2">&quot;deliveryServices&quot;</span><span class="p">:</span>
    <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;deliveryServiceId&quot;</span><span class="p">:</span> <span class="s2">&quot;hls-live&quot;</span><span class="p">,</span>
            <span class="s2">&quot;urlRegex&quot;</span><span class="p">:</span> <span class="s2">&quot;.*live4</span><span class="se">\\</span><span class="s2">.m3u8&quot;</span><span class="p">,</span>
            <span class="s2">&quot;geoLocation&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;includePostalCode&quot;</span><span class="p">:[</span><span class="s2">&quot;N0H&quot;</span><span class="p">,</span> <span class="s2">&quot;L9V&quot;</span><span class="p">,</span> <span class="s2">&quot;L9W&quot;</span><span class="p">]},</span>
            <span class="s2">&quot;redirectUrl&quot;</span><span class="p">:</span> <span class="s2">&quot;http://third-party.com/blacked_out.html&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;deliveryServiceId&quot;</span><span class="p">:</span> <span class="s2">&quot;hls-live&quot;</span><span class="p">,</span>
            <span class="s2">&quot;urlRegex&quot;</span><span class="p">:</span> <span class="s2">&quot;.*live5</span><span class="se">\\</span><span class="s2">.m3u8&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ipWhiteList&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">185.68</span><span class="o">.</span><span class="mf">71.9</span><span class="o">/</span><span class="mi">22</span><span class="s2">&quot;,&quot;</span><span class="mf">142.232</span><span class="o">.</span><span class="mf">0.79</span><span class="o">/</span><span class="mi">24</span><span class="s2">&quot;],</span>
            <span class="s2">&quot;geoLocation&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;excludePostalCode&quot;</span><span class="p">:[</span><span class="s2">&quot;N0H&quot;</span><span class="p">,</span> <span class="s2">&quot;L9V&quot;</span><span class="p">]},</span>
            <span class="s2">&quot;redirectUrl&quot;</span><span class="p">:</span> <span class="s2">&quot;/live5_low_bitrate.m3u8&quot;</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li>The value of &#8220;deliveryServiceId&#8221; shall be equal to the “XML ID” field of the intended delivery service defined on Traffic Ops.</li>
<li>“urlRegex” is to match request URLs. The URLs matching the regex are applicable to the rule.</li>
<li>“geoLocation” currently supports “includePostalCode” and “excludePostalCode” attribute. When “includePostalCode” attribute is used, only the clients whose FSAs are in the “includePostalCode” list are able to view the content represented by “urlRegex”. When “excludePostalCode” is used, any client whose FSA are not in the “excludePostalCode” list are allowed to view the content. “includePostalCode” and “excludePostalCode” are mutually exclusive in one rule. (FSA: Forward Sortation Area, first three postal characters of Canadian postal codes)</li>
<li>“redirectUrl” is the URL that will be responded to the blocked clients. Without a domain name in the URL, the URL will still be served in the same delivery service. Thus Traffic Router will redirect the client to a chosen cache server assigned to the delivery service. If the URL includes a domain name, Traffic Router simply redirects the client to the defined URL. In the later case, the redirect URL must not match the “urlRegex” part to avoid HTTP 302 loop on Traffic Router.</li>
<li>“ipWhiteList” is an optional element. It includes a list of CIDR (Classless Inter-Domain Routing) blocks indicating the IPv4 subnets that are allowed by the rule. If this list exists and the value is not empty, client IP will be matched against the CIDR list, and if there is any match, the request will be allowed and no postal code matching logic is needed. If there is no match in the white list, postal code matching logic will be processed further.</li>
</ul>
<ol class="arabic simple" start="2">
<li>Add RGB parameters on Traffic Ops</li>
</ol>
<p>The two new parameters in following table are required to be added into CRConfig.json:</p>
<ul class="simple">
<li>&#8220;regional_geoblocking.polling.url&#8221;: the HTTP URL of RGB configuration file. Traffic Router will fetch the file from this URL.</li>
<li>&#8220;regional_geoblocking.polling.interval&#8221;: the interval that Traffic Router polls the RGB configuration file.</li>
</ul>
<a class="reference internal image-reference" href="../../_images/regionalgeo01.png"><img alt="../../_images/regionalgeo01.png" class="align-center" src="../../_images/regionalgeo01.png" style="width: 1234.0px; height: 430.0px;" /></a>
<ol class="arabic simple" start="3">
<li>Enable RGB for a delivery service</li>
</ol>
<a class="reference internal image-reference" href="../../_images/regionalgeo02.png"><img alt="../../_images/regionalgeo02.png" class="align-center" src="../../_images/regionalgeo02.png" style="width: 1046.0px; height: 1054.0px;" /></a>
<ol class="arabic simple" start="4">
<li>Make configuration effective</li>
</ol>
<p>Go to Tools-&gt;Snapshot CRConfig, perform “Diff CRConfig” and click &#8220;Write CRConfig&#8221;.</p>
<a class="reference internal image-reference" href="../../_images/regionalgeo03.png"><img alt="../../_images/regionalgeo03.png" class="align-center" src="../../_images/regionalgeo03.png" style="width: 464.8px; height: 128.8px;" /></a>
<ol class="arabic simple" start="5">
<li>Traffic Router access log with RGB</li>
</ol>
<p>RGB extends the field of &#8220;rtype&#8221; and adds a new field &#8220;rgb&#8221; in Traffic Router access.log to help to monitor the working of this feature.</p>
<p>For &#8220;rtype&#8221;, RGALT indicates that a request is redirected to an alternate URL by RGB; RGDENY indicates that a request is denied by RGB because there is no matching rule in JSON for this request.</p>
<p>For &#8220;rgb&#8221;, when RGB is enabled, it will be non-empty with following format:</p>
<div class="highlight-default"><div class="highlight"><pre><span class="p">{</span><span class="n">FSA</span><span class="p">}:{</span><span class="n">allowed</span><span class="o">/</span><span class="n">disallowed</span><span class="p">}:{</span><span class="n">include</span><span class="o">/</span><span class="n">exclude</span> <span class="n">postal</span><span class="p">}:{</span><span class="n">fallback</span> <span class="n">config</span><span class="o">/</span><span class="n">current</span> <span class="n">config</span><span class="p">}:{</span><span class="n">allowed</span> <span class="n">by</span> <span class="n">whitelist</span><span class="o">/</span><span class="n">otherwise</span><span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li>{FSA}: It is the client’s FSA part of its postal code, which is retrieved from geo-location database. If FSA is empty, dash (“-“) is filled in.</li>
<li>{allowed/disallowed}: This flag shows if a request is allowed or disallowed by RGB (1 for yes, and 0 for no).</li>
<li>{include/exclude postal}: It shows that when a rule in JSON is matched for a request, it is an include or exclude list of postal codes (i.e. FSAs). “I” for include, and “X” for exclude. If no rule matches, dash (“-“) is filled in.</li>
<li>{fallback config/current config}: when TR fails to parse an RGB JSON, TR will handle requests with latest valid JSON configuration, but will set {fallback config} flag to 1. If the new JSON is valid, then the flag is set to 0.</li>
<li>{allowed by whitelist/otherwise}: If a request is allowed by whitelist, this flag is set to 1; for all other cases, it is 0.</li>
</ul>
<p>Example:</p>
<div class="highlight-default"><div class="highlight"><pre><span class="mf">1446442214.685</span> <span class="n">qtype</span><span class="o">=</span><span class="n">HTTP</span> <span class="n">chi</span><span class="o">=</span><span class="mf">129.100</span><span class="o">.</span><span class="mf">254.79</span> <span class="n">url</span><span class="o">=</span><span class="s2">&quot;http://ccr.geo2.cdn.com/live5.m3u8&quot;</span> <span class="n">cqhm</span><span class="o">=</span><span class="n">GET</span> <span class="n">cqhv</span><span class="o">=</span><span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span> <span class="n">rtype</span><span class="o">=</span><span class="n">GEO</span> <span class="n">rloc</span><span class="o">=</span><span class="s2">&quot;-&quot;</span> <span class="n">rdtl</span><span class="o">=-</span> <span class="n">rerr</span><span class="o">=</span><span class="s2">&quot;-&quot;</span> <span class="n">rgb</span><span class="o">=</span><span class="s2">&quot;N6G:1:X:0:0&quot;</span> <span class="n">pssc</span><span class="o">=</span><span class="mi">302</span> <span class="n">ttms</span><span class="o">=</span><span class="mi">3</span> <span class="n">rurl</span><span class="o">=</span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">cent6</span><span class="o">-</span><span class="mf">44.</span><span class="n">geo2</span><span class="o">.</span><span class="n">cdn</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">live5</span><span class="o">.</span><span class="n">m3u8</span> <span class="n">rh</span><span class="o">=</span><span class="s2">&quot;-&quot;</span>

<span class="mf">1446442219.181</span> <span class="n">qtype</span><span class="o">=</span><span class="n">HTTP</span> <span class="n">chi</span><span class="o">=</span><span class="mf">184.68</span><span class="o">.</span><span class="mf">71.9</span> <span class="n">url</span><span class="o">=</span><span class="s2">&quot;http://ccr.geo2.cdn.com/live5.m3u8&quot;</span> <span class="n">cqhm</span><span class="o">=</span><span class="n">GET</span> <span class="n">cqhv</span><span class="o">=</span><span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span> <span class="n">rtype</span><span class="o">=</span><span class="n">RGALT</span> <span class="n">rloc</span><span class="o">=</span><span class="s2">&quot;-&quot;</span> <span class="n">rdtl</span><span class="o">=-</span> <span class="n">rerr</span><span class="o">=</span><span class="s2">&quot;-&quot;</span> <span class="n">rgb</span><span class="o">=</span><span class="s2">&quot;-:0:X:0:0&quot;</span> <span class="n">pssc</span><span class="o">=</span><span class="mi">302</span> <span class="n">ttms</span><span class="o">=</span><span class="mi">3</span> <span class="n">rurl</span><span class="o">=</span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">cent6</span><span class="o">-</span><span class="mf">44.</span><span class="n">geo2</span><span class="o">.</span><span class="n">cdn</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">low_bitrate</span><span class="o">.</span><span class="n">m3u8</span> <span class="n">rh</span><span class="o">=</span><span class="s2">&quot;-&quot;</span>

<span class="mf">1446445521.677</span> <span class="n">qtype</span><span class="o">=</span><span class="n">HTTP</span> <span class="n">chi</span><span class="o">=</span><span class="mf">24.114</span><span class="o">.</span><span class="mf">29.79</span> <span class="n">url</span><span class="o">=</span><span class="s2">&quot;http://ccr.geo2.cdn.com/live51.m3u8&quot;</span> <span class="n">cqhm</span><span class="o">=</span><span class="n">GET</span> <span class="n">cqhv</span><span class="o">=</span><span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span> <span class="n">rtype</span><span class="o">=</span><span class="n">RGDENY</span> <span class="n">rloc</span><span class="o">=</span><span class="s2">&quot;-&quot;</span> <span class="n">rdtl</span><span class="o">=-</span> <span class="n">rerr</span><span class="o">=</span><span class="s2">&quot;-&quot;</span> <span class="n">rgb</span><span class="o">=</span><span class="s2">&quot;L4S:0:-:0:0&quot;</span> <span class="n">pssc</span><span class="o">=</span><span class="mi">520</span> <span class="n">ttms</span><span class="o">=</span><span class="mi">3</span> <span class="n">rurl</span><span class="o">=</span><span class="s2">&quot;-&quot;</span> <span class="n">rh</span><span class="o">=</span><span class="s2">&quot;-&quot;</span>
</pre></div>
</div>
</div>


          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="steering.html" class="btn btn-neutral float-right" title="Configure Delivery Service Steering">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="federations.html" class="btn btn-neutral" title="Configure Federations"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'1.8-dev',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>